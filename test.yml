hosts: localhost
  connection: local
  gather_facts: no
  vars:
    vcenter_ip: 'VCENTERIP'
    vcenter_user: 'VCENTERUSER'
    vcenter_password: 'VCENTERPASS'
    vmname: 'VMNAME'
  tasks:
    - name: Wait for the virtual machine to shutdown
      vmware_guest_powerstate:
        hostname: "{{ vcenter_ip }}"
        username: "{{ vcenter_user }}"
        password: "{{ vcenter_password }}"
        name: "AIOP-VA-AAP-CN3"
        validate_certs: False
        state: shutdown-guest
        state_change_timeout: 900
      register: wait
      ignore_errors: yes
 
    - name: ForcePoweroff 
      vmware_guest_powerstate:
        hostname: "{{ vcenter_ip }}"
        username: "{{ vcenter_user }}"
        password: "{{ vcenter_password }}"
        name: "{{ vmname }}"
        validate_certs: False
        state: powered-off
      register: poweroff
      when: wait.msg is search('Timeout')
